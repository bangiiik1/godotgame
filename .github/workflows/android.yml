name: Build Android APK

on:
  push:
    branches: [main]  # Запускает сборку при пуше в ветку main

jobs:
  build-android:
    runs-on: ubuntu-latest  # Используем последнюю версию Ubuntu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # Обновлённая версия чекаута

      - name: Cache Godot export templates
        uses: actions/cache@v4
        with:
          path: ~/.cache/godot-export-templates
          key: godot-export-templates-v1

      - name: Export Godot game to Android
        uses: firebelley/godot-export@v7.0.0  # Заменили brackeys на firebelley
        with:
          godot_executable_download_url: https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_linux.x86_64.zip
          godot_export_templates_download_url: https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz
          relative_project_path: ./  # Путь к project.godot (в корне репозитория)
          archive_output: true  # Архивирует результат в .zip
          target: android  # Указываем целевую платформу
          export_presets_path: export_presets.cfg  # Путь к файлу настроек экспорта (если есть)

      - name: Upload built APK as artifact
        uses: actions/upload-artifact@v4  # Обновлённая версия загрузки артефактов
        with:
          name: android-apk  # Имя артефакта
          path: ./android/  # Путь к папке с собранным APK
          retention-days: 30  # Храним артефакт 30 дней

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            android/*.apk
            android/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
